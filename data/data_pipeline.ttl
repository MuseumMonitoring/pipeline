@prefix xsd: <http://www.w3.org/2001/XMLSchema#>.
@prefix rdfc: <https://w3id.org/rdf-connect#>.
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>.
@prefix ex: <http://example.org/>.
@prefix cidoc: <http://www.cidoc-crm.org/cidoc-crm/>.
@prefix sosa: <http://www.w3.org/ns/sosa/>.
@prefix dcterms: <http://purl.org/dc/terms/>.
@prefix sh: <http://www.w3.org/ns/shacl#>.
@prefix tree: <https://w3id.org/tree#>.
@prefix rml: <http://w3id.org/rml/>.
@prefix ws: <https://w3id.org/conn/ws#>.
@prefix : <https://w3id.org/conn#>.
@prefix owl: <http://www.w3.org/2002/07/owl#>.
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>.
@prefix rml: <https://w3id.org/conn/rml#>.
@prefix ql: <http://semweb.mmlab.be/ns/ql#>.
@prefix rdfl: <https://w3id.org/rdf-lens/ontology#>.

<> owl:imports <../node_modules/@rdfc/js-runner/index.ttl>.
<> owl:imports <../proc/fetch.ttl>.
<> owl:imports <../proc/mumo_mapper.ttl>.
<> owl:imports <../node_modules/@rdfc/sds-processors-ts/configs/ldes_disk_writer.ttl>.
<> owl:imports <../node_modules/@rdfc/sds-processors-ts/configs/bucketizer.ttl>.
<> owl:imports <../node_modules/@rdfc/sds-processors-ts/configs/shapify.ttl>.
<> owl:imports <../node_modules/@rdfc/sds-processors-ts/configs/sdsify.ttl>.
<> owl:imports <../node_modules/@rdfc/file-utils-processors-ts/processors.ttl>.
<> owl:imports <../shape.ttl>.
#
<> a rdfc:Pipeline;
  rdfc:consistsOf [
    rdfc:instantiates rdfc:NodeRunner;
    rdfc:processor <mapper>,
      <inputReader>,
      <sdsify>,
      <metaReader>,
      <bucketizer>,
      <shapify>,
      <ingestor>,
      <logger>;
  ].

# <shapify>,
# <mapper>,
# A node runner, runs things that are rdfc:jsImplementationOf rdfc:Processor  (aka, rdfs:subClassOf prov:Activity)
rdfc:NodeRunner a rdfc:Runner;
  rdfc:handlesSubjectsOf rdfc:jsImplementationOf;
  rdfc:command "npx js-runner".

<json> a rdfc:Reader, rdfc:Writer.
<ttl> a rdfc:Reader, rdfc:Writer.
#
<inputReader> a rdfc:GlobRead;
  rdfc:glob <../test_ttn_msg.json>;
  rdfc:output <json>;
  rdfc:closeOnEnd "true".

<mapper> a rdfc:MumoMapper;
  rdfc:trigger <json>;
  rdfc:dataInput <json>;
  rdfc:dataOutput <ttl>.

<sdsify> a rdfc:Sdsify;
  rdfc:input <ttl>;
  rdfc:output <sds-raw>;
  rdfc:objectType <http://def.isotc211.org/iso19156/2011/Observation#OM_Observation>;
  rdfc:timestampPath <http://def.isotc211.org/iso19156/2011/Observation#OM_Observation.resultTime>;
  rdfc:typeFilter <http://def.isotc211.org/iso19156/2011/Observation#OM_Observation>;
  rdfc:stream <http://data.mumo.be/streams/sds>;
  rdfc:shape """
@prefix sosa: <http://www.w3.org/ns/sosa/>.
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>.
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>.
@prefix sh: <http://www.w3.org/ns/shacl#>.
@prefix xsd: <http://www.w3.org/2001/XMLSchema#>.
@prefix foaf: <http://xmlns.com/foaf/0.1/>.
@prefix ex: <http://example.org/>.
@prefix cidoc: <http://www.cidoc-crm.org/cidoc-crm/>.

# http://www.cidoc-crm.org/cidoc-crm/P53_has_former_or_current_location
ex:Measurement a sh:NodeShape;
  sh:property [
    sh:path sosa:madeBySensor;
    sh:minCount 1;
    sh:node [ sh:property [
      sh:path [ sh:inversePath sosa:hosts ];
      sh:node [
        a sh:NodeShape;
        sh:property [
          sh:path sosa:hosts;
          sh:minCount 1;
          sh:node [ sh:property [
            sh:path rdf:type;
            sh:minCount 1;
          ] ];
        ];
      ];
      sh:minCount 1;
    ] ];
  ], [
    sh:path (
      <http://def.isotc211.org/iso19156/2011/Observation#OM_Observation.result>
      <http://qudt.org/1.1/schema/qudt#unit>
    );
    sh:node [];
  ].
""".

<metadata> a rdfc:Reader, rdfc:Writer.
<sds-raw> a rdfc:Reader, rdfc:Writer.
<raw/buckets-1> a rdfc:Reader, rdfc:Writer.
<meta/buckets-1> a rdfc:Reader, rdfc:Writer.
<metaReader> a rdfc:GlobRead;
  rdfc:glob <./metadataIn.ttl>;
  rdfc:output <metadata>;
  rdfc:closeOnEnd "true".

<bucketizer> a rdfc:Bucketize;
  rdfc:channels [
    rdfc:dataInput <sds-raw>;
    rdfc:metadataInput <metadata>;
    rdfc:dataOutput <raw/buckets-1>;
    rdfc:metadataOutput <meta/buckets-1>;
  ];
  rdfc:bucketizeStrategy ( #   [
  #   a tree:SubjectFragmentation;
  #   tree:fragmentationPath (
  #     sosa:madeBySensor
  #     [ sh:inversePath sosa:hosts ]
  #     cidoc:P55_has_current_location
  #     [ sh:zeroOrMorePath dcterms:isPartOf ]
  #   );
  #   tree:fragmentationDefaultName "unlocated";
  #   tree:fragmentationPathName dcterms:title;
  # ] [
  #   a tree:SubjectFragmentation;
  #   tree:fragmentationPath ( sosa:madeBySensor [ sh:inversePath sosa:hosts ] );
  #   tree:fragmentationDefaultName "unknown";
  #   tree:fragmentationPathName dcterms:title;
  # ] [
  #   a tree:SubjectFragmentation;
  #   tree:fragmentationPath (
  #     <http://def.isotc211.org/iso19156/2011/Observation#OM_Observation.result>
  #     <http://qudt.org/1.1/schema/qudt#unit>
  #   );
  #   tree:fragmentationDefaultName "unknown";
  #   tree:fragmentationPathName rdfs:label;
  # ]
  [
    a tree:TimeBucketFragmentation;
    tree:timestampPath <http://def.isotc211.org/iso19156/2011/Observation#OM_Observation.resultTime>;
    tree:level ( [
      tree:range "year";
      tree:maxSize 0;
    ] [
      tree:range "month";
      tree:maxSize 0;
    ] [
      tree:range "day-of-month";
      tree:maxSize 1000;
    ] [
      tree:range "hour";
      tree:maxSize 1000;
    ] [
      tree:range "minute";
      tree:maxSize 10000;
    ] );
  ] );
  rdfc:savePath <./buckets_save_1.json>;
  rdfc:outputStreamId <https://w3id.org/sds#Stream>.

# rdfc:outputStreamId <http://data.mumo.be/streams/buckets/1>.
<shaped-1> a rdfc:Reader, rdfc:Writer.

<shapify> a rdfc:Shapify;
  rdfc:input <raw/buckets-1>;
  rdfc:output <shaped-1>;
  rdfc:shape <ValueShape>.

<ingestor> a rdfc:LdesDiskWriter;
  rdfc:dataInput <shaped-1>;
  rdfc:metadataInput <meta/buckets-1>;
  rdfc:directory "./ldes2/".

[ ] a rdfc:Ingest;
  rdfc:dataInput <shaped-1>;
  rdfc:metadataInput <meta/buckets-1>;
  rdfc:database <DataBaseConfig>.

<logger> a <Log>;
  rdfc:input <shaped-1>,
    <meta/buckets-1>,
    <ttl>,
    <json>,
    <sds-raw>,
    <raw/buckets-1>.

# [ ] a rdfc:Bucketize;
#   rdfc:prefix "root/";
#   rdfc:channels [ ];
#   # snip
#   rdfc:bucketizeStrategy ( [
#     a tree:SubjectFragmentation;
#     tree:fragmentationPath ( sosa:madeBySensor [ sh:inversePath sosa:hosts ] );
#     tree:fragmentationDefaultName "unknown";
#     tree:fragmentationPathName dcterms:title;
#   ] [
#     a tree:SubjectFragmentation;
#     tree:fragmentationPath (
#       <http://def.isotc211.org/iso19156/2011/Observation#OM_Observation.result>
#       <http://qudt.org/1.1/schema/qudt#unit>
#     );
#     tree:fragmentationDefaultName "unknown";
#     tree:fragmentationPathName rdfs:label;
#   ] );
#   rdfc:savePath <./buckets_save_2.json>;
#   rdfc:outputStreamId <http://data.mumo.be/streams/buckets/2>.
#
# [ ] a rdfc:Shapify;
#   rdfc:input <raw/buckets-2/reader>;
#   rdfc:output <shaped-2/writer>;
#   rdfc:shape <ValueShape>.
#
# [ ] a rdfc:Ingest;
#   rdfc:dataInput <shaped-2/reader>;
#   rdfc:metadataInput <meta/buckets-2/reader>;
#   rdfc:database <DataBaseConfig>.
<DataBaseConfig> rdfc:data "DATA";
  rdfc:index "INDEX";
  rdfc:metadata "META";
  rdfc:url [
    a rdfl:EnvVariable;
    # rdfl:envDefault "redis://127.0.0.1:6379/mumotest";
    rdfl:envDefault "redis://127.0.0.1:6377/";
    rdfl:envKey "REDIS";
  ].

<NodeShape> a sh:NodeShape;
  sh:closed true;
  sh:property [
    sh:path <http://www.cidoc-crm.org/cidoc-crm/P55_has_current_location>;
    sh:node [
      sh:closed true;
      sh:property [ sh:path [ sh:zeroOrMorePath dcterms:isPartOf ] ];
    ];
  ].

<ValueShape> a sh:NodeShape;
  sh:closed true;
  sh:property [ sh:path rdf:type ],
    [ sh:path <http://def.isotc211.org/iso19156/2011/Observation#OM_Observation.resultTime> ],
    [
      sh:path <http://def.isotc211.org/iso19156/2011/Observation#OM_Observation.result>;
      sh:node [
        sh:closed true;
        sh:property [ sh:path rdf:type ],
          [ sh:path <http://qudt.org/1.1/schema/qudt#unit> ],
          [ sh:path <http://qudt.org/1.1/schema/qudt#numericValue> ];
      ];
    ],
    [
      sh:path sosa:madeBySensor;
      sh:node [
        sh:closed true;
        sh:property [
          # sh:path [ sh:inversePath sosa:hosts ];
          sh:path sosa:isHostedBy;
          sh:node <NodeShape>;
        ];
      ];
    ].

<> a rdfc:FileProfilerShape;
  rdfc:path "/tmp/profile.csv";
  rdfc:intervalMs 2000.

<Log> a owl:Class, rdfs:Class;
  rdfc:jsImplementationOf rdfc:Processor;
  rdfs:label "Log Things";
  rdfs:comment "Logs things";
  rdfc:file <../lib/utils.js>;
  rdfc:class "Logger";
  rdfs:entrypoint <../>.

[ ] a sh:NodeShape;
  sh:targetClass <Log>;
  sh:property [
    sh:name "streams";
    sh:path rdfc:input;
    sh:class rdfc:Reader;
  ].

