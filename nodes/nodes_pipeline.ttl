@prefix ex: <http://example.org/>.
@prefix cidoc: <http://www.cidoc-crm.org/cidoc-crm/>.
@prefix sosa: <http://www.w3.org/ns/sosa/>.
@prefix dcterms: <http://purl.org/dc/terms/>.
@prefix sh: <http://www.w3.org/ns/shacl#>.
@prefix tree: <https://w3id.org/tree#>.
@prefix rml: <http://w3id.org/rml/>.
@prefix js: <https://w3id.org/conn/js#>.
@prefix ws: <https://w3id.org/conn/ws#>.
@prefix : <https://w3id.org/conn#>.
@prefix owl: <http://www.w3.org/2002/07/owl#>.
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>.
@prefix rml: <https://w3id.org/conn/rml#>.
@prefix ql: <http://semweb.mmlab.be/ns/ql#>.
@prefix rdfl: <https://w3id.org/rdf-lens/ontology#>.
@prefix rdfc: <https://w3id.org/rdf-connect/ontology#>.

<> owl:imports <../node_modules/@rdfc/js-runner/index.ttl>.
<> owl:imports <../proc/fetch.ttl>.
<> owl:imports <../proc/mumo_nodes.ttl>.
<> owl:imports <../node_modules/@rdfc/file-utils-processors-ts/processors.ttl>.
<> owl:imports <../node_modules/@rdfc/sds-processors-ts/configs/bucketizer.ttl>.
<> owl:imports <../node_modules/@rdfc/sds-processors-ts/configs/ldesify.ttl>.
<> owl:imports <../node_modules/@rdfc/sds-processors-ts/configs/sdsify.ttl>.
<> owl:imports <../node_modules/@rdfc/sds-processors-ts/configs/ldes_disk_writer.ttl>.
<> owl:imports <../shape.ttl>.
<> a rdfc:Pipeline;
  rdfc:dependency <>;
  rdfc:processor <MumoSource>,
    <Sdsify>,
    <Ldesify>,
    <MetaDataReader>,
    <Bucketize>,
    # <Ingest>,
    # <Ingest-2>,
    <Ldes>;
  rdfc:runner rdfc:JsRunner.

rdfc:JsRunner rdfc:handles rdfc:Processor.
<MumoSource> a js:MumoSource;
  js:dataOutput <ttl>.

<Sdsify> a rdfc:Sdsify;
  js:input <ttl>;
  js:output <sds-raw>;
  js:objectType <http://www.w3.org/ns/sosa/Platform>;
  js:typeFilter <http://www.w3.org/ns/sosa/Platform>;
  js:stream <sds>;
  js:shape """
@prefix sosa: <http://www.w3.org/ns/sosa/>.
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>.
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>.
@prefix sh: <http://www.w3.org/ns/shacl#>.
@prefix xsd: <http://www.w3.org/2001/XMLSchema#>.
@prefix foaf: <http://xmlns.com/foaf/0.1/>.
@prefix ex: <http://example.org/>.
@prefix cidoc: <http://www.cidoc-crm.org/cidoc-crm/>.
@prefix dcterms: <http://purl.org/dc/terms/>.

# http://www.cidoc-crm.org/cidoc-crm/P53_has_former_or_current_location
ex:SensorShape a sh:NodeShape;
  sh:property [
    sh:path sosa:hosts;
    sh:node [ sh:property [ sh:path rdf:type ] ];
  ], [
    sh:path <http://purl.org/dc/terms/hasPart>;
    sh:node [ sh:property [ sh:path rdf:type ] ];
  ], [
    sh:path (cidoc:P55_has_current_location [ sh:zeroOrMorePath dcterms:isPartOf ] );
    sh:node [ ];
  ].
""".

<Ldesify> a rdfc:LdesifySDS;
  js:input <sds-raw>;
  js:output <ldes-raw>;
  js:statePath <./ldesState.json>;
  js:targetStream <http://data.mumo.be/streams/nodes/ldes>.

<MetaDataReader> a rdfc:GlobRead;
  js:glob "./nodes/metadataIn.ttl";
  js:output <metadata>.

<Bucketize> a rdfc:Bucketize;
  js:channels [
    js:dataInput <ldes-raw>;
    js:metadataInput <metadata>;
    js:dataOutput <raw/buckets-1>;
    js:metadataOutput <meta/buckets-1>;
  ];
  js:bucketizeStrategy ( [
    a tree:SubjectFragmentation;
    tree:fragmentationPath <http://purl.org/dc/terms/isVersionOf>;
    tree:fragmentationDefaultName "unknown";
    tree:fragmentationPathName dcterms:title;
  ] );
  js:savePath <./buckets_nodes_save-1.json>;
  js:outputStreamId <default>.

# [ ] a js:Bucketize;
#   js:channels [
#     js:dataInput <ldes-raw>;
#     js:metadataInput <metadata>;
#     js:dataOutput <raw/buckets-2>;
#     js:metadataOutput <meta/buckets-2>;
#   ];
#   js:bucketizeStrategy ( [
#     a tree:SubjectFragmentation;
#     tree:fragmentationPath (
#       <http://purl.org/dc/terms/isVersionOf>
#       cidoc:P55_has_current_location
#       [ sh:zeroOrMorePath dcterms:isPartOf ]
#     );
#     tree:fragmentationDefaultName "unlocated";
#     tree:fragmentationPathName dcterms:title;
#   ] [
#     a tree:SubjectFragmentation;
#     tree:fragmentationPath <http://purl.org/dc/terms/isVersionOf>;
#     tree:fragmentationDefaultName "unknown";
#     tree:fragmentationPathName dcterms:title;
#   ] );
#   js:savePath <./buckets_nodes_save-2.json>;
#   js:outputStreamId <http://data.mumo.be/streams/nodes/by-location>.
<Ingest> a rdfc:LogProcessor;
  rdfc:reader <raw/buckets-1>.

<Ldes> a rdfc:LdesDiskWriter;
  js:dataInput <raw/buckets-1>;
  js:metadataInput <meta/buckets-1>;
  js:directory "./ldes".

<Ingest-2> a rdfc:LogProcessor;
  rdfc:reader <meta/buckets-1>.

# <Ingest> a js:Ingest;
#   js:dataInput <raw/buckets-1>;
#   js:metadataInput <meta/buckets-1>;
#   js:database <DataBaseConfig>.
# [ ] a js:Ingest;
#   js:dataInput <raw/buckets-2>;
#   js:metadataInput <meta/buckets-2>;
#   js:database <DataBaseConfig>.
<DataBaseConfig> js:data "DATA";
  js:index "INDEX";
  js:metadata "META";
  js:url [
    a rdfl:EnvVariable;
    # rdfl:envDefault "redis://127.0.0.1:6379/mumotest";
    rdfl:envDefault "redis://127.0.0.1:6378/";
    rdfl:envKey "REDIS";
  ].

# js:url "mongodb://mongodb:27017/mumoNodes";
