@prefix rdfl: <https://w3id.org/rdf-lens/ontology#>.
@prefix cidoc: <http://www.cidoc-crm.org/cidoc-crm/>.
@prefix sosa: <http://www.w3.org/ns/sosa/>.
@prefix tree: <https://w3id.org/tree#>.
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>.
@prefix sh: <http://www.w3.org/ns/shacl#>.
@prefix rdfc: <https://w3id.org/rdf-connect#>.
@prefix owl: <http://www.w3.org/2002/07/owl#>.

<> owl:imports <./bucketize_strategies.ttl>.
<> owl:imports <../node_modules/@rdfc/js-runner/index.ttl>.
<> owl:imports <../proc/fetch.ttl>.
<> owl:imports <../proc/mumo_mapper.ttl>.
<> owl:imports <../node_modules/@rdfc/sds-processors-ts/configs/bucketizer.ttl>.
<> owl:imports <../node_modules/@rdfc/sds-processors-ts/configs/shapify.ttl>.
<> owl:imports <../node_modules/@rdfc/sds-processors-ts/configs/sdsify.ttl>.
<> owl:imports <../node_modules/@rdfc/file-utils-processors-ts/processors.ttl>.
<> owl:imports <../node_modules/@rdfc/sds-processors-ts/configs/ldes_disk_writer.ttl>.
<> owl:imports <../node_modules/@rdfc/stream-utils/index.ttl>.
<> a rdfc:Pipeline;
  rdfc:consistsOf [
    rdfc:instantiates rdfc:NodeRunner;
    rdfc:processor <by-location>,
      <by-sensor>,
      <fetchData>,
      <fetchSensors>,
      <mapper>,
      <sdsify-data>,
      <ingestor>,
      <metaReader>,
      <metaReaderSensor>,
      <data-combine>,
      <sds-dup>,
      <sdsify-sensor>,
      <sensor-fan>,
      <sensor-converge>,
      <bucketize-sensor-location>,
      <bucketize-sensor-id>,
      <ingest-sensors>;
  ].

<sensors/json> a rdfc:Reader, rdfc:Writer.
<sensors/ttl> a rdfc:Reader, rdfc:Writer.
<mapped> a rdfc:Reader, rdfc:Writer;
  rdfc:log "debug".

<data> a rdfc:Reader, rdfc:Writer.
<trigger> a rdfc:Reader, rdfc:Writer.
<sds-raw> a rdfc:Reader, rdfc:Writer.
<sds-raw-1> a rdfc:Reader, rdfc:Writer.
<sds-raw-2> a rdfc:Reader, rdfc:Writer.
#
<fetchData> a rdfc:MumoFetch;
  rdfc:dataOutput <data>;
  rdfc:delay <trigger>;
  rdfc:intervalMs 5000;
  rdfc:savePath <./state/data-save.json>;
  # rdfc:startUrl "http://localhost:8080/history.php?data".
  rdfc:startUrl [
    a rdfl:EnvVariable;
    rdfl:envDefault "https://www.mumodashboard.be/history.php?data";
    rdfl:envKey "dataHistory";
  ].

<fetchSensors> a rdfc:MumoFetch;
  rdfc:dataOutput <sensors/json>;
  rdfc:intervalMs 5000;
  # rdfc:startUrl "http://localhost:8080/history.php?sensors".
  rdfc:startUrl [
    a rdfl:EnvVariable;
    rdfl:envDefault "https://www.mumodashboard.be/history.php?sensors";
    rdfl:envKey "sensorHistory";
  ].

<mapper> a rdfc:MumoMapper;
  rdfc:trigger <trigger>;
  rdfc:data [
    rdfc:reader <data>;
    rdfc:writer <mapped>;
  ];
  rdfc:sensor [
    rdfc:reader <sensors/json>;
    rdfc:writer <sensors/ttl>;
  ].

<sdsify-sensor> a rdfc:Sdsify;
  rdfc:input <sensors/ttl>;
  rdfc:output <sensors/sds>;
  rdfc:objectType sosa:Platform;
  rdfc:typeFilter sosa:Platform;
  # rdfc:timestampPath <http://schema.org/validFrom>;
  rdfc:stream <http://data.mumo.be/streams/sensors>;
  rdfc:shape """
@prefix sosa: <http://www.w3.org/ns/sosa/>.
@prefix sh: <http://www.w3.org/ns/shacl#>.

<Platform> a sh:NodeShape;
  sh:property [
    sh:path sosa:hosts;
    sh:node [
        sh:property [
            sh:path sosa:observes;
            sh:node [];
        ];
    ];
  ].
""".

<sensor-fan> a rdfc:FanOut;
  rdfc:reader <sensors/sds>;
  rdfc:writer <sensors/sds-1>, <sensors/sds-2>.

<sensor-converge> a rdfc:Converge;
  rdfc:reader <sensor/buckets-1>, <sensor/buckets-2>;
  rdfc:writer <sensor/buckets>.

<bucketize-sensor-location> a rdfc:Bucketize;
  rdfc:channels [
    rdfc:dataInput <sensors/sds-1>;
    rdfc:metadataInput <sensor/metadata>;
    rdfc:dataOutput <sensor/buckets-1>;
    rdfc:metadataOutput <sensor/metadata/2>;
  ];
  rdfc:savePath <./state/bucketize-sensor-location.json>;
  rdfc:bucketizeStrategy ( <sensorLocationFragmentation> );
  rdfc:outputStreamId <http://data.mumo.be/streams/sensors/by-location>.

<bucketize-sensor-id> a rdfc:Bucketize;
  rdfc:channels [
    rdfc:dataInput <sensors/sds-2>;
    rdfc:metadataInput <sensor/metadata/2>;
    rdfc:dataOutput <sensor/buckets-2>;
    rdfc:metadataOutput <sensor/metadata/3>;
  ];
  rdfc:savePath <./state/bucketize-sensor-id.json>;
  rdfc:bucketizeStrategy ( <sensorFragmentation> );
  rdfc:outputStreamId <http://data.mumo.be/streams/sensors/by-id>.

<ingest-sensors> a rdfc:LdesDiskWriter;
  rdfc:dataInput <sensor/buckets>;
  rdfc:metadataInput <sensor/metadata/3>;
  rdfc:directory <./ldes/sensors/>;
  rdfc:streamName [
    rdfc:stream <http://data.mumo.be/streams/sensors/by-location>;
    rdfc:name "by-location";
  ], [
    rdfc:stream <http://data.mumo.be/streams/sensors/by-id>;
    rdfc:name "by-name";
  ].

<sdsify-data> a rdfc:Sdsify;
  rdfc:input <mapped>;
  rdfc:output <sds-raw>;
  rdfc:objectType <http://def.isotc211.org/iso19156/2011/Observation#OM_Observation>;
  rdfc:timestampPath <http://def.isotc211.org/iso19156/2011/Observation#OM_Observation.resultTime>;
  rdfc:typeFilter <http://def.isotc211.org/iso19156/2011/Observation#OM_Observation>;
  rdfc:stream <http://data.mumo.be/streams/sds>;
  rdfc:shape """
@prefix sosa: <http://www.w3.org/ns/sosa/>.
@prefix sh: <http://www.w3.org/ns/shacl#>.
@prefix ex: <http://example.org/>.

ex:Measurement a sh:NodeShape;
  sh:property [
    sh:path sosa:madeBySensor;
    sh:minCount 1;
    sh:node [
        sh:property [
            sh:path sosa:isHostedBy;
            sh:node [];
        ];
    ];
  ], [
    sh:path (
      <http://def.isotc211.org/iso19156/2011/Observation#OM_Observation.result>
      <http://qudt.org/1.1/schema/qudt#unit>
    );
    sh:node [];
  ].
""".

<sds-dup> a rdfc:FanOut;
  rdfc:reader <sds-raw>;
  rdfc:writer <sds-raw-1>, <sds-raw-2>.

<metadata> a rdfc:Reader, rdfc:Writer.
<raw/buckets-1> a rdfc:Reader, rdfc:Writer.
<meta/buckets-1> a rdfc:Reader, rdfc:Writer.
<meta/buckets-2> a rdfc:Reader, rdfc:Writer.
<metaReader> a rdfc:GlobRead;
  rdfc:glob <./metadataIn.ttl>;
  rdfc:output <metadata>;
  rdfc:closeOnEnd "true".

<metaReaderSensor> a rdfc:GlobRead;
  rdfc:glob <./sensor-metadata.ttl>;
  rdfc:output <sensor/metadata>;
  rdfc:closeOnEnd "true".

<data-combine> a rdfc:Converge;
  rdfc:reader <raw/buckets-1-1>, <raw/buckets-1-2>;
  rdfc:writer <raw/buckets-1>.

<by-location> a rdfc:Bucketize;
  rdfc:channels [
    rdfc:dataInput <sds-raw-1>;
    rdfc:metadataInput <metadata>;
    rdfc:dataOutput <raw/buckets-1-1>;
    rdfc:metadataOutput <meta/buckets-1>;
  ];
  rdfc:bucketizeStrategy ( <dataLocationFragmentation> <timeFragmentation> );
  rdfc:savePath <./state/by-location.json>;
  # rdfc:bucketizeStrategy <dataLocationFragmentation>;
  # rdfc:savePath <./buckets_save_1.json>;
  rdfc:outputStreamId <https://w3id.org/sds#Stream>.

# The root fragment is located at '/root/' this defaults to ''
<by-sensor> a rdfc:Bucketize;
  rdfc:channels [
    rdfc:dataInput <sds-raw-2>;
    rdfc:metadataInput <meta/buckets-1>;
    rdfc:dataOutput <raw/buckets-1-2>;
    rdfc:metadataOutput <meta/buckets-2>;
  ];
  rdfc:bucketizeStrategy ( <dataSensorFragmentation> <timeFragmentation> );
  rdfc:savePath <./state/by-sensor.json>;
  rdfc:outputStreamId <https://w3id.org/sds#Stream2>.

<ingestor> a rdfc:LdesDiskWriter;
  rdfc:dataInput <raw/buckets-1>;
  rdfc:metadataInput <meta/buckets-2>;
  rdfc:directory <./ldes/data>;
  rdfc:streamName [
    rdfc:stream <https://w3id.org/sds#Stream>;
    rdfc:name "by-location";
  ], [
    rdfc:stream <https://w3id.org/sds#Stream2>;
    rdfc:name "by-sensor";
  ].

<logger> a <Log>;
  rdfc:input <mapped>.

<Log> a owl:Class, rdfs:Class;
  rdfc:jsImplementationOf rdfc:Processor;
  rdfs:label "Log Things";
  rdfs:comment "Logs things";
  rdfc:file <../lib/utils.js>;
  rdfc:class "Logger";
  rdfc:entrypoint <../>.

[ ] a sh:NodeShape;
  sh:targetClass <Log>;
  sh:property [
    sh:name "streams";
    sh:path rdfc:input;
    sh:class rdfc:Reader;
  ].

